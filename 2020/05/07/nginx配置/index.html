
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>nginx配置 - wanghui&#39;s blogs</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    
    <meta name="description" content="Nginx的基本配置 2017-10-18 |   Visit count 367
Nginx配置文件主要分成四部分：main（全局设置）、http（HTTP的通用设置）、server（虚拟主机设置,"> 
    <meta name="author" content="wanghui"> 
    <link rel="alternative" href="atom.xml" title="wanghui&#39;s blogs" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
</head>
</html>
<body class="loading">
    <span id="config-title" style="display:none">wanghui&#39;s blogs</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" data-url="https://wanghui096.github.io"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">nginx配置</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">nginx配置</h1>
        <div class="stuff">
            <span>五月 07, 2020</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/nginx/">-nginx</a></li></ul>


        </div>
        <div class="content markdown">
            <h2 id="Nginx的基本配置"><a href="#Nginx的基本配置" class="headerlink" title="Nginx的基本配置"></a>Nginx的基本配置</h2><p> 2017-10-18 |   Visit count 367</p>
<p>Nginx配置文件主要分成四部分：main（全局设置）、http（HTTP的通用设置）、server（虚拟主机设置）、location（匹配URL路径）。还有一些其他的配置段，如event，upstream等。</p>
<p>一个完整的Nginx配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">user       www www;  ## Default: nobody</span><br><span class="line">worker_processes  5;  ## Default: 1</span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 8192;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections  4096;  ## Default: 1024</span><br><span class="line">  multi_accept on;</span><br><span class="line">  use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  include    conf/mime.types;</span><br><span class="line">  include    /etc/nginx/proxy.conf;</span><br><span class="line">  include    /etc/nginx/fastcgi.conf;</span><br><span class="line">  index    index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">  log_format   main &apos;$remote_addr - $remote_user [$time_local]  $status &apos;</span><br><span class="line">                    &apos;&quot;$request&quot; $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">  access_log   logs/access.log  main;</span><br><span class="line">  sendfile     on;</span><br><span class="line">  tcp_nopush   on;</span><br><span class="line">  server_names_hash_bucket_size 128; # this seems to be required for some vhosts</span><br><span class="line"></span><br><span class="line">  server &#123; # php/fastcgi</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  domain1.com www.domain1.com;</span><br><span class="line">    access_log   logs/domain1.access.log  main;</span><br><span class="line">    root         html;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">      fastcgi_pass   127.0.0.1:1025;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123; # simple reverse-proxy</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  domain2.com www.domain2.com;</span><br><span class="line">    access_log   logs/domain2.access.log  main;</span><br><span class="line"></span><br><span class="line">    # serve static files</span><br><span class="line">    location ~ ^/(images|javascript|js|css|flash|media|static)/  &#123;</span><br><span class="line">      root    /var/www/virtual/big.server.com/htdocs;</span><br><span class="line">      expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # pass requests for dynamic content to rails/turbogears/zope, et al</span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass      http://127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  upstream big_server_com &#123;</span><br><span class="line">    server 127.0.0.3:8000 weight=5;</span><br><span class="line">    server 127.0.0.3:8001 weight=5;</span><br><span class="line">    server 192.168.0.1:8000;</span><br><span class="line">    server 192.168.0.1:8001;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123; # simple load balancing</span><br><span class="line">    listen          80;</span><br><span class="line">    server_name     big.server.com;</span><br><span class="line">    access_log      logs/big.server.access.log main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass      http://big_server_com;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx基础配置指令"><a href="#Nginx基础配置指令" class="headerlink" title="Nginx基础配置指令"></a>Nginx基础配置指令</h2><h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><p>用于指定运行Nginx的用户和组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user user [group]</span><br></pre></td></tr></table></figure>

<p>只有被设置的用户或者用户组成员才有权限启动Nginx服务。如果希望所有用户都可以启动Nginx，则只需将其注释掉或者指定为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user nobody nobody</span><br></pre></td></tr></table></figure>

<h3 id="worker-processes"><a href="#worker-processes" class="headerlink" title="worker_processes"></a>worker_processes</h3><p>指定Nginx的工作进程的个数，可以设置为与 CPU 数量相同，基本语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes number|auto</span><br></pre></td></tr></table></figure>

<p>设置为auto时，Nginx进程将自动检测。当worker_processes设置为1时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># sbin/nginx </span><br><span class="line"># ps -ef|grep nginx</span><br><span class="line">root      5882  1326  0 13:07 ?        00:00:00 nginx: master process sbin/nginx</span><br><span class="line">nobody    5883  5882  0 13:07 ?        00:00:00 nginx: worker process</span><br><span class="line">root      5885  5430  0 13:07 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>将worker_processes设置为3时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ps -ef|grep nginx</span><br><span class="line">root      5919  1326  0 13:09 ?        00:00:00 nginx: master process sbin/nginx</span><br><span class="line">nobody    5920  5919  0 13:09 ?        00:00:00 nginx: worker process</span><br><span class="line">nobody    5921  5919  0 13:09 ?        00:00:00 nginx: worker process</span><br><span class="line">nobody    5922  5919  0 13:09 ?        00:00:00 nginx: worker process</span><br><span class="line">root      5924  5430  0 13:09 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>worker_processes进程数变成了3个。</p>
<h3 id="error-log"><a href="#error-log" class="headerlink" title="error_log"></a>error_log</h3><p>用于配置错误日志的存放路径。http，server和location块也可配置error_log，区别在于级别不一样。基本语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log files|stderr [ debug | info | notice | warn | error | crit | alert | emerg ]</span><br></pre></td></tr></table></figure>

<p>debug级别最高，emerg级别最低。比如设置级别为warn后，warn，error，crit，alert和emerg级别的日志都会被记录。Nginx默认日志存放路径为：<code>logs/error.log</code>。</p>
<h3 id="pid"><a href="#pid" class="headerlink" title="pid"></a>pid</h3><p>pid指令用于指定存放Nginx主进程号存放文件的路径。默认的路径为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ./sbin/nginx </span><br><span class="line"># cat logs/nginx.pid </span><br><span class="line">101106</span><br></pre></td></tr></table></figure>

<h3 id="worker-rlimit-nofile"><a href="#worker-rlimit-nofile" class="headerlink" title="worker_rlimit_nofile"></a>worker_rlimit_nofile</h3><p>设置毎个进程的最大文件打开数。如果不设的话上限就是系统的ulimit –n的数字（1024）。</p>
<h3 id="worker-connections"><a href="#worker-connections" class="headerlink" title="worker_connections"></a>worker_connections</h3><p>设定一个worker进程的最大连接数。默认为512，按自己系统的硬件配置调整，不能超过worker_rlimit_nofile。</p>
<h3 id="include"><a href="#include" class="headerlink" title="include"></a>include</h3><p>include指令用于引入第三方配置文件，比如常见的MIME类型等。</p>
<h3 id="accept-mutex"><a href="#accept-mutex" class="headerlink" title="accept_mutex"></a>accept_mutex</h3><p>该条指令目的是为了解决“惊群”的问题。“惊群”大致意思是：当某个时刻只有一个网络连接时，多个进程会被同时唤醒，但最终实际上只有一个进程可以获得连接，由于唤醒了别的不必要的进程，造成了性能的浪费。</p>
<p>accept_mutex语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex on | off</span><br></pre></td></tr></table></figure>

<p>默认为开启（on）状态，只能在events块中进行设置。</p>
<h3 id="multi-accept"><a href="#multi-accept" class="headerlink" title="multi_accept"></a>multi_accept</h3><p>用于设置是否允许worker_process同时接受多个网络连接。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi_accept on | off</span><br></pre></td></tr></table></figure>

<p>其默认为关闭（off）状态，也就是说每个worker_process一次只能接收一个新到达的网络连接。</p>
<p>该指令只能在events模块中设置。</p>
<h3 id="use"><a href="#use" class="headerlink" title="use"></a>use</h3><p>use指令用于选择事件的驱动模型。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use method</span><br></pre></td></tr></table></figure>

<p>Nginx提供了多种事件驱动模型来处理网络消息，method可选的内容有：select，poll，kqueue，epoll，rtsig，/dev/poll和eventport。</p>
<p>该指令只能在events模块中设置。</p>
<h3 id="worker-connentions"><a href="#worker-connentions" class="headerlink" title="worker_connentions"></a>worker_connentions</h3><p>用于设置每个worker_process最大的连接数。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_process number</span><br></pre></td></tr></table></figure>

<p>该指令只能在events模块中设置。</p>
<h3 id="指定MIME"><a href="#指定MIME" class="headerlink" title="指定MIME"></a>指定MIME</h3><p>在配置文件中，可以看到如下两条配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include    conf/mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br></pre></td></tr></table></figure>

<p>include指令引入了mime.types文件，其中mime.types内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">types &#123;</span><br><span class="line">    text/html                             html htm shtml;</span><br><span class="line">    text/css                              css;</span><br><span class="line">    text/xml                              xml;</span><br><span class="line">    image/gif                             gif;</span><br><span class="line">    image/jpeg                            jpeg jpg;</span><br><span class="line">    application/javascript                js;</span><br><span class="line">    application/atom+xml                  atom;</span><br><span class="line">    application/rss+xml                   rss;</span><br><span class="line"></span><br><span class="line">    text/mathml                           mml;</span><br><span class="line">    text/plain                            txt;</span><br><span class="line">    text/vnd.sun.j2me.app-descriptor      jad;</span><br><span class="line">    text/vnd.wap.wml                      wml;</span><br><span class="line">    text/x-component                      htc;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    video/3gpp                            3gpp 3gp;</span><br><span class="line">    video/mp2t                            ts;</span><br><span class="line">    video/mp4                             mp4;</span><br><span class="line">    video/mpeg                            mpeg mpg;</span><br><span class="line">    video/quicktime                       mov;</span><br><span class="line">    video/webm                            webm;</span><br><span class="line">    video/x-flv                           flv;</span><br><span class="line">    video/x-m4v                           m4v;</span><br><span class="line">    video/x-mng                           mng;</span><br><span class="line">    video/x-ms-asf                        asx asf;</span><br><span class="line">    video/x-ms-wmv                        wmv;</span><br><span class="line">    video/x-msvideo                       avi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>default_type application/octet-stream</code>指定了默认类型为二进制流。如果不指定的话，默认值为text/plain。</p>
<p>该指令可以在http，server或location模块中设置。</p>
<h3 id="自定义服务日志"><a href="#自定义服务日志" class="headerlink" title="自定义服务日志"></a>自定义服务日志</h3><p>error_log用于记录Nginx运行时的常规日志，而access_log（服务日志）是指Nginx服务器在响应各种前端请求的日志。包含两个指令：access_log和log_format。</p>
<p>access_log的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log ptah[format[buffer=size]]</span><br></pre></td></tr></table></figure>

<p><code>path</code>用于指定该日志的存放路径，<code>format</code>为可选项，代指自定义服务日志的格式字符串。<code>size</code>为可选项，用于配置临时存放日志的内存缓存区大小。</p>
<p>log_format的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_format name string ...</span><br></pre></td></tr></table></figure>

<p><code>name</code>用于为该格式定义一个变量名，供access_log指令使用。<code>string</code>为格式字符串，比如：<code>$remote_addr - $remote_user [$time_local] $status</code>其中<code>$remote_addr</code>等为Nginx预设的一些变量，常用的变量有：</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>说明</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>客户端地址</td>
<td>211.28.65.253</td>
</tr>
<tr>
<td>$remote_user</td>
<td>客户端用户名称</td>
<td>–</td>
</tr>
<tr>
<td>$time_local</td>
<td>访问时间和时区</td>
<td>18/Jul/2012:17:00:01 +0800</td>
</tr>
<tr>
<td>$request</td>
<td>请求的URI和HTTP协议</td>
<td>“GET /article-10000.html HTTP/1.1”</td>
</tr>
<tr>
<td>$http_host</td>
<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>
<td><a href="http://www.it300.com/" target="_blank" rel="noopener">www.it300.com</a> 192.168.100.100</td>
</tr>
<tr>
<td>$status</td>
<td>HTTP请求状态</td>
<td>200</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>upstream状态</td>
<td>200</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端文件内容大小</td>
<td>1547</td>
</tr>
<tr>
<td>$http_referer</td>
<td>url跳转来源</td>
<td><a href="https://www.baidu.com/" target="_blank" rel="noopener">https://www.baidu.com/</a></td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户终端浏览器等信息</td>
<td>“Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;</td>
</tr>
<tr>
<td>$ssl_protocol</td>
<td>SSL协议版本</td>
<td>TLSv1</td>
</tr>
<tr>
<td>$ssl_cipher</td>
<td>交换数据中的算法</td>
<td>RC4-SHA</td>
</tr>
<tr>
<td>$upstream_addr</td>
<td>后台upstream的地址，即真正提供服务的主机地址</td>
<td>10.10.10.100:80</td>
</tr>
<tr>
<td>$request_time</td>
<td>整个请求的总时间</td>
<td>0.205</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>请求过程中，upstream响应时间</td>
<td>0.002</td>
</tr>
</tbody></table>
<p>该指令只能在http模块中设置。</p>
<h3 id="sendfile-amp-sendfile-max-chunk"><a href="#sendfile-amp-sendfile-max-chunk" class="headerlink" title="sendfile &amp; sendfile_max_chunk"></a>sendfile &amp; sendfile_max_chunk</h3><p>sendfile用于开启或关闭使用sendfile()传输文件。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendfile on | off</span><br></pre></td></tr></table></figure>

<p>可以在http，server或location中进行配置。</p>
<p>sendfile_max_chunk用于设置Nginx进程中的每个worker_process每次调用sendfile()传输的数据量的最大值。默认值为0，表示没有限制。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendfile_max_chunk 128k</span><br></pre></td></tr></table></figure>

<p>该指令可以在http，server或location块中配置。</p>
<h3 id="keepalive-timeout"><a href="#keepalive-timeout" class="headerlink" title="keepalive_timeout"></a>keepalive_timeout</h3><p>用于设置Nginx服务器与用户建立会话连接保持的时间，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout timeout[header_timeout]</span><br></pre></td></tr></table></figure>

<p><code>timeout</code>用于设置服务器端保持连接的时间；<code>header_timeout</code>为可选项，用于配置应答报文头部的Keep-Alive域的值。</p>
<p>该指令可以在http，server和location块中配置。</p>
<h3 id="keepalive-requests"><a href="#keepalive-requests" class="headerlink" title="keepalive_requests"></a>keepalive_requests</h3><p>用于限制用户通过某一连接向服务器发送请求的次数，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keepalive_requests number</span><br></pre></td></tr></table></figure>

<p>默认值为100，可以在http，server和location块中配置。</p>
<h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h3><p>该指令用于配置监听。配置方法主要有三种：</p>
<p>1、配置监听的IP地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen address[:port] [default_server] [setfib=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [deferred] [accept_filter=filter] [bind] [ssl]</span><br></pre></td></tr></table></figure>

<p>2、配置监听端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen port [default_server] [setfib=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [deferred] [accept_filter=filter] [bind] [ipv6only=on|off] [ssl]</span><br></pre></td></tr></table></figure>

<p>3、配置UNIX Domain Socket</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen unix:path [default_server] [setfib=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [deferred] [accept_filter=filter] [bind] [ssl]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>address</code>，IP地址，如果是IPv6的地址，需使用[]，比如[fe80 ::1]。</li>
<li><code>port</code>，端口号。</li>
<li><code>path</code>，socket文件路径，如/var/run/nginx.sock等。</li>
<li><code>default_server</code>，标识符，表示设置为默认主机。</li>
<li><code>rcvbuf=size</code>，设置监听socket接收缓存区大小。</li>
<li><code>sndbuf=size</code>，设置监听socket发送缓存区大小。</li>
<li><code>deferred</code>，标识符，将accept()设置为Deferred模式。</li>
<li><code>accept_filter=filter</code>，设置监听端口对请求的过滤 ，被过滤的内容不能被接收和处理。</li>
<li><code>ssl</code>，标识符，设置会话连接使用SSL模式进行。</li>
</ul>
<p>一些例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen *:80 | *:8080;  #监听所有80端口和8080端口</span><br><span class="line">listen 192.168.1.10:8080; 　#监听具体IP和具体端口上的连接</span><br><span class="line">listen 8000;  #监听所有IP地址的8000端口，等同于 listen *:8000</span><br><span class="line">listen 192.168.1.10 default_server;  #设置192.168.1.10的连接请求默认由此虚拟主机处理</span><br></pre></td></tr></table></figure>

<h3 id="server-name"><a href="#server-name" class="headerlink" title="server_name"></a>server_name</h3><p>Nginx配置文件中的每个server块对于一个虚拟主机配置，server_name用于指定虚拟主机的名称，用户可通过这个名称来向此虚拟主机发送请求。server_name的配置分为名称和IP两种方式。</p>
<p><strong>基于名称的虚拟主机配置</strong></p>
<p>基于名称的虚拟主机配置时，server_name的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name name ...</span><br></pre></td></tr></table></figure>

<p>name可以有一个或多个名称并列，用空格隔开。每个名称对应一个域名，由两段或者三段组成，之间由<code>.</code>隔开。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name www.mrbird.cc mrbird.cc;</span><br></pre></td></tr></table></figure>

<p>1、在name中可以使用通配符<code>*</code>，通配符可用在三段式域名的头或尾，或两段式域名的尾部，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name *.mrbird.cc mrbird.*;</span><br></pre></td></tr></table></figure>

<p>2、在name中还可以使用正则表达式。使用<code>~</code>作为正则表达式开始的标记，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name ~^www\d+\.mrbird\.cc$;</span><br></pre></td></tr></table></figure>

<p>此时比如通过<code>www1.mrbird.cc</code>可以访问Nginx服务，而<code>www.mrbird.cc</code>不可以。</p>
<p>name中的正则表达式支持字符串捕获功能，字符串捕获通过<code>( )</code>来拾取后面不紧跟其他的正则表达式的字符。一个正则表达式中可以存在多个不嵌套的小括号，这些内容会从左到右依次存放在变量<code>$1</code>、<code>$2</code>、<code>$3</code>……中。下文使用时就可直接使用这些变量，作用域为当前的server块。</p>
<p>比如有如下的server_name配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name ~^www\.(.+)\.cc$;</span><br></pre></td></tr></table></figure>

<p>当通过<code>www.mrbird.cc</code>访问Nginx服务器时，将会被上面的正则表达式匹配成功，mrbird将会被捕获，并且赋值给$1。</p>
<p>由于有两种匹配的方式，所以有可能出现两种情况都匹配的时候，这时候Nginx按照以下的优先级进行选择：</p>
<ol>
<li>准确匹配server_name。</li>
<li>通配符在开始时匹配server_name成功。</li>
<li>通配符在结束时匹配server_name成功。</li>
<li>正则表达式匹配server_name成功。</li>
</ol>
<p>此外，如果server_name被处于同一优先级的匹配方式多次匹配成功，则以首先匹配成功的为主。</p>
<p><strong>基于IP的虚拟主机配置</strong></p>
<p>Linux操作系统支持IP别名的添加，配置基于IP的虚拟主机，即为Nginx服务器提供的每台虚拟主机配置一个不同的IP。</p>
<p>查看当前网络配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># ifconfig</span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0c:29:25:f3:bb  </span><br><span class="line">          inet addr:192.168.112.128  Bcast:192.168.112.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::4fe4:f0e0:9e9b:7ec/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:360100 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:89081 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:504446360 (504.4 MB)  TX bytes:7347923 (7.3 MB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:35127 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:35127 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:2931450 (2.9 MB)  TX by</span><br></pre></td></tr></table></figure>

<p>ens33为正在使用的网卡，IP为<code>192.168.112.128</code>，给其添加两个IP别名<code>192.168.112.130</code>和<code>192.168.112.131</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># ifconfig ens33:0 192.168.112.130 Mask 255.255.255.0 up </span><br><span class="line"># ifconfig ens33:1 192.168.112.131 Mask 255.255.255.0 up </span><br><span class="line"># ifconfig</span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0c:29:25:f3:bb  </span><br><span class="line">          inet addr:192.168.112.128  Bcast:192.168.112.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::4fe4:f0e0:9e9b:7ec/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:360100 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:89081 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:504446360 (504.4 MB)  TX bytes:7347923 (7.3 MB)</span><br><span class="line"></span><br><span class="line">ens33:0   Link encap:Ethernet  HWaddr 00:0c:29:25:f3:bb  </span><br><span class="line">          inet addr:192.168.112.130  Bcast:192.168.112.255  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">ens33:1   Link encap:Ethernet  HWaddr 00:0c:29:25:f3:bb  </span><br><span class="line">          inet addr:192.168.112.131  Bcast:192.168.112.255  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:221 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:221 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:16787 (16.7 KB)  TX bytes:16787 (16.7 KB)</span><br></pre></td></tr></table></figure>

<p>关于给网卡添加多个IP别名可以参考<a href="http://www.cnblogs.com/biaopei/p/7730517.html" target="_blank" rel="noopener">http://www.cnblogs.com/biaopei/p/7730517.html</a></p>
<p>这时候就可以在Nginx配置文件中配置两台基于IP配置的虚拟主机了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  http &#123;</span><br><span class="line">  	...</span><br><span class="line">  	server &#123;</span><br><span class="line">  		listen: 80;</span><br><span class="line">  		server_name: 192.168.112.130;</span><br><span class="line">  		...</span><br><span class="line">  	&#125;</span><br><span class="line">  	server &#123;</span><br><span class="line">  		listen: 80;</span><br><span class="line">  		server_name: 192.168.112.131;</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="location块"><a href="#location块" class="headerlink" title="location块"></a>location块</h3><p>location语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>uri是待匹配的请求字符串，可以是标准uri（不含正则表达式）和正则uri。</p>
<ul>
<li><code>=</code>用于标准uri前，要求请求字符串与uri严格匹配，如果成功，则停止搜索并立即处理此请求。</li>
<li><code>~</code>用于表示uri含正则表达式，区分大小写。</li>
<li><code>~*</code>用于表示uri包含正则表达式，不区分大小写。</li>
<li><code>^~</code>用于标准uri前，要求Nginx服务器找到和请求字符串匹配度最高的标准uri对应的location后，立即用此location处理请求，而不再使用location块中的正则uri和请求字符串做匹配。</li>
</ul>
<p>一个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">location  = / &#123;</span><br><span class="line">  # 精确匹配 / ，主机名后面不能带任何字符串</span><br><span class="line">  [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">location  / &#123;</span><br><span class="line">  # 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求</span><br><span class="line">  # 但是正则和最长字符串会优先匹配</span><br><span class="line">  [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">location /documents/ &#123;</span><br><span class="line">  # 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索</span><br><span class="line">  # 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span><br><span class="line">  [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line">location ~ /documents/Abc &#123;</span><br><span class="line">  # 匹配任何以 /documents/Abc 开头的地址，匹配符合以后，还要继续往下搜索</span><br><span class="line">  # 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span><br><span class="line">  [ configuration CC ]</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">  # 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。</span><br><span class="line">  [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">  # 匹配所有以 gif,jpg或jpeg 结尾的请求</span><br><span class="line">  # 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则</span><br><span class="line">  [ configuration E ]</span><br><span class="line">&#125;</span><br><span class="line">location /images/ &#123;</span><br><span class="line">  # 字符匹配到 /images/，继续往下，会发现 ^~ 存在</span><br><span class="line">  [ configuration F ]</span><br><span class="line">&#125;</span><br><span class="line">location /images/abc &#123;</span><br><span class="line">  # 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在</span><br><span class="line">  # F与G的放置顺序是没有关系的</span><br><span class="line">  [ configuration G ]</span><br><span class="line">&#125;</span><br><span class="line">location ~ /images/abc/ &#123;</span><br><span class="line">  # 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用</span><br><span class="line">    [ configuration H ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>匹配的优先级：</p>
<p>(location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location <del>,</del>* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p>
<p>按照上面的location写法，以下的匹配示例成立：</p>
<ul>
<li>/ -&gt; config A 精确完全匹配，即使/index.html也匹配不了。</li>
<li>/downloads/download.html -&gt; config B 匹配B以后，往下没有任何匹配，采用B。</li>
<li>/images/1.gif -&gt; configuration D 匹配到F，往下匹配到D，停止往下。</li>
<li>/images/abc/def -&gt; config D 最长匹配到G，往下匹配D，停止往下。 你可以看到 任何以/images/开头的都会匹配到D并停止，FG写在这里是没有任何意义的，H是永远轮不到的，这里只是为了说明匹配顺序</li>
<li>/documents/document.html -&gt; config C 匹配到C，往下没有任何匹配，采用C。</li>
<li>/documents/1.jpg -&gt; configuration E 匹配到C，往下正则匹配到E。</li>
<li>/documents/Abc.jpg -&gt; config CC 最长匹配到C，往下正则顺序匹配到CC，不会往下到E。</li>
</ul>
<blockquote>
<p>参考自： <a href="http://seanlook.com/2015/05/17/nginx-location-rewrite/" target="_blank" rel="noopener">seanlook’s blog</a></p>
</blockquote>
<h3 id="root"><a href="#root" class="headerlink" title="root"></a>root</h3><p>root用于配置根目录，比如有如下location配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /data/ &#123;</span><br><span class="line">   root /locationtest1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当location块接收到<code>/data/index.html</code>的请求后，将在<code>/locationtest1/data/</code>目录下找到index.html。</p>
<p>该指令可在http，server或location块中配置。</p>
<h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><p>alias用于改变location接收到的URI请求路径。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/data/(.+\.html)$ &#123;</span><br><span class="line">   alias /locationtest1/other/$1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当location块接收到<code>/data/index.html</code>的请求后，通过alias，Nginx到<code>/locationtest1/other/</code>目录下搜寻index.html。相当于请求从<code>/data/index.html</code>更改为了<code>/locationtest1/other/index.html</code>。</p>
<h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><p>index用于设置网站的默认首页。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/data/(.+)/web/ $ &#123;</span><br><span class="line">   index index.$1.html index.html myindex.html</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求为/data/locationtest1/web/时，Nginx依次搜寻index.locationtest1.html、index.html和myindex.html页面，先找到哪个就用哪个。</p>
<h3 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h3><p>该指令用于设置网站的错误页面。语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page code ... [=[response]] uri</span><br></pre></td></tr></table></figure>

<ul>
<li><code>code</code>，要处理的HTTP错误码。</li>
<li><code>response</code>，可选项，将code指定的错误码转化为新的错误代码response。</li>
<li><code>uri</code>，错误页面的路径或者网站地址。</li>
</ul>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 /404.html;</span><br></pre></td></tr></table></figure>

<p>Nginx使用<code>Nginx安装目录/html/404.html</code>页面响应404错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page 403 http://somewebsite.com/forbidden.html;</span><br></pre></td></tr></table></figure>

<p>Nginx使用<code>http://somewebsite.com/forbidden.html</code>页面响应403错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_page 410 =301 /empty.gif;</span><br></pre></td></tr></table></figure>

<p>Nginx服务器产生410的HTTP消息时，使用<code>Nginx安装目录/html/empty.gif</code>返回给用户，HTTP的状态码为301。</p>
<p>加入想要改变<code>Nginx安装目录/html/</code>这个默认的路径，可以添加一个locaiton块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /404.html &#123;</span><br><span class="line">   root /myserver/errorpages/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该指令可在http，server和location块中配置。</p>
<h3 id="基于IP配置Nginx访问权限"><a href="#基于IP配置Nginx访问权限" class="headerlink" title="基于IP配置Nginx访问权限"></a>基于IP配置Nginx访问权限</h3><p>allow指令用于配置允许访问Nginx的客户端IP，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow address | CIDR | all</span><br></pre></td></tr></table></figure>

<ul>
<li><code>address</code>，指定允许访问的IP，不支持多个值，如需要有多个IP设置，需要重复使用allow命令。</li>
<li><code>CIDR</code>，允许访问的客户端的CIDR地址。</li>
<li><code>all</code>，代表允许所有的客户端访问。</li>
</ul>
<p>deny指令用于配置禁止访问Nginx的客户端IP，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deny address | CIDR | all</span><br></pre></td></tr></table></figure>

<p>这两个指令可在http，server和location块中配置。</p>
<h3 id="配置Nginx密码"><a href="#配置Nginx密码" class="headerlink" title="配置Nginx密码"></a>配置Nginx密码</h3><p>auth_basic指令用于开启或者关闭认证功能，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth_basic string | off</span><br></pre></td></tr></table></figure>

<ul>
<li><code>stirng</code>，开启认证功能，并配置了验证时的信息。</li>
<li><code>off</code>，关闭认证。</li>
</ul>
<p>auth_basic_user_file指令指定了包含用户名和密码的信息文件路径，语法结构为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth_basic_user_file file</span><br></pre></td></tr></table></figure>

<p>如，在nignx.conf里配置如下：</p>
<p><img src="https://mrbird.cc/img/mrbird_pohto_20171101114239.png" alt="mrbird_photo_20171101112512"></p>
<p>生产htpasswd文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># printf &quot;mrbird:$(openssl passwd -crypt 123456)\n&quot; &gt;&gt;conf/htpasswd</span><br><span class="line"># cat conf/htpasswd</span><br><span class="line">mrbird:vdV.OwMSzfJrQ</span><br></pre></td></tr></table></figure>

<p>重启Nginx后，访问<a href="http://localhost/index.html" target="_blank" rel="noopener">http://localhost/index.html</a>，页面显示如下：</p>
<p><img src="https://mrbird.cc/img/mrbird_photo_20171101112838.png" alt="mrbird_photo_20171101112838"></p>
<h2 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h2><p>将conf/nginx.conf配置成如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                       &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                       &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    </span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    # 配置server1</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8081;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        </span><br><span class="line">        charset utf-8;</span><br><span class="line">        </span><br><span class="line">        access_log  /myweb/server1/log/access.log  main;</span><br><span class="line">        </span><br><span class="line">        error_page  404 /myweb/error/404.html;</span><br><span class="line">        # 配置/server1/location1/请求的location</span><br><span class="line">        location /server1/location1 &#123;</span><br><span class="line">            root   /myweb;</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 配置/server1/location2请求的location</span><br><span class="line">        location /server1/location2 &#123;</span><br><span class="line">            root   /myweb;</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    # 配置server2</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8082;</span><br><span class="line">        server_name  192.168.112.130;</span><br><span class="line">        </span><br><span class="line">        charset utf-8;</span><br><span class="line">        </span><br><span class="line">        access_log  /myweb/server2/log/access.log  main;</span><br><span class="line">        </span><br><span class="line">        error_page  404 /404.html;</span><br><span class="line">        # 配置/server2/location1/请求的locaiton</span><br><span class="line">        location /server2/location1 &#123;</span><br><span class="line">            root   /myweb;</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 配置/server2/location2/请求的location</span><br><span class="line">        location /svr2/loc2 &#123;</span><br><span class="line">            alias   /myweb/server2/location2; # 对location的uri进行更改</span><br><span class="line">            index  index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 重定向404页面地址</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">            root /myweb/error;</span><br><span class="line">            index 404.html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建一个静态网站，目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/myweb/</span><br><span class="line">├── error</span><br><span class="line">│   └── 404.html</span><br><span class="line">├── server1</span><br><span class="line">│   ├── location1</span><br><span class="line">│   │   └── index.html</span><br><span class="line">│   ├── location2</span><br><span class="line">│   │   └── index.html</span><br><span class="line">│   └── log</span><br><span class="line">│       └── access.log</span><br><span class="line">└── server2</span><br><span class="line">    ├── location1</span><br><span class="line">    │   └── index.html</span><br><span class="line">    ├── location2</span><br><span class="line">    │   └── index.html</span><br><span class="line">    └── log</span><br><span class="line">        └── access.log</span><br></pre></td></tr></table></figure>

<p>启动Nginx服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /nginx/conf/nginx.conf test is successful</span><br><span class="line"># /nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://localhost:8081/server1/location1/" target="_blank" rel="noopener">http://localhost:8081/server1/location1/</a>：</p>
<p><img src="https://mrbird.cc/img/mrbird_photo_20171101151244.png" alt="mrbird_photo_20171101151244.png"></p>
<p>访问<a href="http://localhost:8081/server1/location2/" target="_blank" rel="noopener">http://localhost:8081/server1/location2/</a>：</p>
<p><img src="https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20171101151332.png" alt="QQ截图20171101151332.png"></p>
<p>访问<a href="http://192.168.112.130:8082/server2/location1/" target="_blank" rel="noopener">http://192.168.112.130:8082/server2/location1/</a>：</p>
<p><img src="https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20171101151521.png" alt="QQ截图20171101151521.png"></p>
<p>访问<a href="http://192.168.112.130:8082/svr2/loc2/" target="_blank" rel="noopener">http://192.168.112.130:8082/svr2/loc2/</a>：</p>
<p><img src="https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20171101151607.png" alt="QQ截图20171101151607.png"></p>
<p>访问<a href="http://192.168.112.130:8082/svr2/loc3/" target="_blank" rel="noopener">http://192.168.112.130:8082/svr2/loc3/</a>：</p>
<p><img src="https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20171101151711.png" alt="QQ截图20171101151711.png"></p>
<p>结果证明，上述配置正确。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='https://link.hhtjim.com/163/1382596189.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='https://link.hhtjim.com/163/573168813.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='false'
        data-ci='8e1a9b5147f7cc935017'
        data-cs='650ffc5e3656ebc61a441a2e4bba901c6377c234'
        data-r='wanghui096.github.io'
        data-o='wanghui096'
        data-a='wanghui096'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
